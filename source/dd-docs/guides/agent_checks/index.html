

<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Writing an Agent Check</title>
    

    <meta itemprop="description" name="description" property="og:description" content="" />

    <link href="//fonts.googleapis.com/css?family=Open+Sans:700" rel="stylesheet" type="text/css">
    <link href="/static/css/bootstrap3-cbdde23cd71.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/tipuesearch.css">
    <link href="/static/css/style-cba6fad8d5d.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/static/pygments.css" media="screen">


    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>


    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-21102638-5']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
    <script src="https://use.fontawesome.com/700fac0342.js"></script>
    
  </head>

  <body>
    <!-- HEADER -->
<div class="navbar navbar-static-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#topmenu" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand " href="/">
        <img src="/static/dd_docs_logo.png">
      </a>
    </div>
    <div class="collapse navbar-collapse" id="topmenu">
      <ul class="nav navbar-nav navbar-right">
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Guides <span class="caret"></span></a>
          <ul class="dropdown-menu">
          
            
              <li>
                <a href="/guides/basic_agent_usage/">Getting Started with the Agent</a>
              </li>
              
              <li>
                <a href="/guides/overview/">Datadog Overview</a>
              </li>
              
              <li>
                <a href="/guides/hostmap/">Host Map Overview</a>
              </li>
              
              <li>
                <a href="/guides/integration_sdk/">Creating New Integrations</a>
              </li>
              
              <li>
                <a href="/guides/installcoreextra/">Installing Core & Extra Integrations</a>
              </li>
              
              <li>
                <a href="/guides/eventcorrelation/">Correlating Events with Metrics</a>
              </li>
              
              <li>
                <a href="/guides/metrics/">Sending Metrics with DogStatsD</a>
              </li>
              
              <li>
                <a href="/guides/logs/">Log Parsing in the Agent</a>
              </li>
              
              <li>
                <a href="/guides/testing/">Testing Integrations</a>
              </li>
              
              <li>
                <a href="/guides/agent_checks/">Writing an Agent Check</a>
              </li>
              
              <li>
                <a href="/guides/chef/">Deploying the Agent with Chef</a>
              </li>
              
              <li>
                <a href="/guides/azure/">Deploying the Datadog Agent to Azure</a>
              </li>
              
              <li>
                <a href="/guides/monitors/">Guide to Monitors</a>
              </li>
              
              <li>
                <a href="/guides/composite_monitors/">Guide to Composite Monitors</a>
              </li>
              
              <li>
                <a href="/guides/markdown/">Using Markdown in Datadog events</a>
              </li>
              
              <li>
                <a href="/guides/autodiscovery/">Guide to using Autodiscovery with Docker</a>
              </li>
              
              <li>
                <a href="/guides/tagging/">Guide to Tagging</a>
              </li>
              
              <li>
                <a href="/guides/templating/">Guide to Dashboard Templating</a>
              </li>
              
              <li>
                <a href="/guides/saml/">Single Sign On With SAML</a>
              </li>
              
              <li>
                <a href="/guides/eventsemail/">Events via Email</a>
              </li>
              
              <li>
                <a href="/guides/new_integration/">Officially Integrating with Datadog</a>
              </li>
              
              <li>
                <a href="/guides/anomalies/">Anomaly Detection</a>
              </li>
              
              <li>
                <a href="/guides/outliers/">Outlier Detection</a>
              </li>
              
              <li>
                <a href="/guides/multiaccountorg/">Configuring Teams & Organizations with Multiple Accounts</a>
              </li>
              
          </ul>
        </li>
        <li class="dropdown">
          <a id="nav-reference-dropdown" href="#" role="button" class="dropdown-toggle" data-toggle="dropdown">References <b class="caret"></b></a>
          <ul class="dropdown-menu dropdown-menu-left" role="menu" aria-labelledby="nav-guide-dropdown">
            <li><a href="/api/">API</a></li>
            <li><a href="/tracing/">Tracing (APM)</a></li>
            <li><a href="/libraries/">Libraries</a></li>
            <li><a href="/monitoring/">Monitoring</a></li>
            <li><a href="/graphing/">Graphing</a></li>
            <li><a href="/graphingjson/">Graphing using JSON</a></li>
            <li><a href="/hostnames/">Host Names</a></li>
            <li><a href="/integrations/">Integrations</a></li>
            <li><a href="/guides/dogstatsd/">DogStatsD</a></li>
            <li><a href="/examples/">Examples</a></li>
            <li><a href="/videos/">Videos</a></li>
            <li><a href="/guides/billing/">Billing</a></li>
            <li><a href="/faq/">FAQ</a></li>
          </ul>
        </li>
        
        <li class="hidden-sm hidden-md hidden-lg">
          <form class="navbar-form navbar-left" role="search" action="/search/">
            <div class="form-group">
              <input type="text" name="q" id="tipue_search_input" required class="form-control" placeholder="Search">
            </div>
          </form>
        </li>
        
        <li><a href="/help/">Help</a></li>
        <li id="signin">
          <a class="btn navbar-btn flexbutton blueflex" href="https://app.datadoghq.com/signup">Free Trial</a>
        </li>
        <li id="signup">
          <a class="btn navbar-btn flexbutton" href="https://help.datadoghq.com/hc/en-us/signin?return_to=https%3A%2F%2Fhelp.datadoghq.com%2Fhc%2Fen-us&locale=1">Support Login</a>
        </li>
      </ul>
    </div>
  </div>
</div>
<!-- END HEADER -->

    <div class="container">
      <div class="row">
      
        <!-- SIDEBAR -->
        <div class="col-sm-3 col-md-3 hidden-xs hidden-print" id="sidebarcolumn">
          <ul class="nav nav-tabs nav-stacked sidebar">
          
            <li class="nav-header">Documentation Search</li>
            <li>
              <form action="/search/">
                <input type="text" name="q" id="tipue_search_input" autocomplete="off" required>
              </form>
            </li>
            
            <li class='nav-header'>Table of Contents</li><li><a href='#overview' onclick="$('#').collapse('show')">Overview</a></li><li><a href='#setup' onclick="$('#').collapse('show')">Setup</a></li><li><a href='#interface' onclick="$('#').collapse('show')">Agent Check Interface</a></li><li><a href='#config' onclick="$('#').collapse('show')">Configuration</a></li><li><a href='#directory' onclick="$('#').collapse('show')">Directory Structure</a></li><li><a href='#first' onclick="$('#').collapse('show')">Your First Check</a></li><li><a href='#http' onclick="$('#').collapse('show')">An HTTP Check</a></li>
            
            
              <li class="nav-header">Guides </li>
              
              
                <li><a href="/guides/basic_agent_usage/">Getting Started with the Agent</a></li>
              
                <li><a href="/guides/overview/">Datadog Overview</a></li>
              
                <li><a href="/guides/hostmap/">Host Map Overview</a></li>
              
                <li><a href="/guides/integration_sdk/">Creating New Integrations</a></li>
              
                <li><a href="/guides/installcoreextra/">Installing Core & Extra Integrations</a></li>
              
                <li><a href="/guides/eventcorrelation/">Correlating Events with Metrics</a></li>
              
                <li><a href="/guides/metrics/">Sending Metrics with DogStatsD</a></li>
              
                <li><a href="/guides/logs/">Log Parsing in the Agent</a></li>
              
                <li><a href="/guides/testing/">Testing Integrations</a></li>
              
                <li><a href="/guides/agent_checks/">Writing an Agent Check</a></li>
              
                <li><a href="/guides/chef/">Deploying the Agent with Chef</a></li>
              
                <li><a href="/guides/azure/">Deploying the Datadog Agent to Azure</a></li>
              
                <li><a href="/guides/monitors/">Guide to Monitors</a></li>
              
                <li><a href="/guides/composite_monitors/">Guide to Composite Monitors</a></li>
              
                <li><a href="/guides/markdown/">Using Markdown in Datadog events</a></li>
              
                <li><a href="/guides/autodiscovery/">Guide to using Autodiscovery with Docker</a></li>
              
                <li><a href="/guides/tagging/">Guide to Tagging</a></li>
              
                <li><a href="/guides/templating/">Guide to Dashboard Templating</a></li>
              
                <li><a href="/guides/saml/">Single Sign On With SAML</a></li>
              
                <li><a href="/guides/eventsemail/">Events via Email</a></li>
              
                <li><a href="/guides/new_integration/">Officially Integrating with Datadog</a></li>
              
                <li><a href="/guides/anomalies/">Anomaly Detection</a></li>
              
                <li><a href="/guides/outliers/">Outlier Detection</a></li>
              
                <li><a href="/guides/multiaccountorg/">Configuring Teams & Organizations with Multiple Accounts</a></li>
              
            
          </ul>
        &nbsp;
        </div>
        <!-- END SIDEBAR -->
        
        <!-- MAIN -->
        <div class="col-xs-12 col-sm-9 col-md-9 main">
          <!-- PAGE TITLE -->
          
          <h1 id="pagetitle">Writing an Agent Check </h1>
          
          
          <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body>
<div class="alert alert-block">
This guide requires an Agent version &gt;= 3.2.0. Older versions of the Agent do
not include the `AgentCheck` interface that we'll be using.
</div>

<!--
======================================================
OVERVIEW
======================================================
-->

<h3 id="overview" class="linked-header">
<a class="header-link" href="#overview"><i class="fa fa-link"></i></a>Overview</h3>
<p>This guide details how to collect metrics and events from a new data source
by writing an Agent Check, a Python plugin to the Datadog Agent. We’ll
look at the <code>AgentCheck</code> interface, and then write a simple Agent Check
that collects timing metrics and status events from HTTP services.</p>

<p>Any custom checks will be included in the main check run loop, meaning
they will run every check interval, which defaults to 15 seconds.</p>

<h4 id="check_or_integration" class="linked-header">
<a class="header-link" href="#check_or_integration"><i class="fa fa-link"></i></a>Should you write an Agent Check or an Integration?</h4>
<p>Agent Checks are a great way to collect metrics from custom applications or unique systems. However, if you are trying to collect metrics from a generally available application, public service or open source project, we recommend that you write an Integration.</p>

<p>Starting with version 5.9 of the Datadog Agent, we’ve enabled a new method for creating integrations and created a corresponding integrations-extras repository where you can contribute your own integrations. This allows integrations to be released and updated independently from Datadog Agent updates, it also provides an easier way for you to share integrations and will make it easier for the wider Datadog community to use your integrations.</p>

<p>For more information about how to write an Integration, please see the <a href="/guides/integration_sdk/">Creating New Integrations guide</a> and check out the <a href="https://github.com/DataDog/integrations-extras">Integrations-Extras Github repo</a> to see other contributed integrations.</p>

<!--
======================================================
SETUP
======================================================
-->

<h3 id="setup" class="linked-header">
<a class="header-link" href="#setup"><i class="fa fa-link"></i></a>Setup</h3>

<p>First off, ensure you’ve properly
<a href="http://app.datadoghq.com/account/settings#agent">installed the
Agent</a> on your machine. If you run into any issues during the setup, pop by
our chatroom, <a href="irc://irc.freenode.net/datadog">#datadog on FreeNode</a>,
and we’ll be happy to answer any questions you might have. (There’s a
<a href="http://webchat.freenode.net/?randomnick=1&amp;channels=datadog&amp;prompt=1">
web chat client, too</a>.)</p>

<!--
======================================================
INTERFACE
======================================================
-->

<h3 id="interface" class="linked-header">
<a class="header-link" href="#interface"><i class="fa fa-link"></i></a>Agent Check Interface</h3>

<p>All custom checks inherit from the <code>AgentCheck</code> class found in <code>checks/__init__.py</code>
and require a <code>check()</code> method that takes one argument, <code>instance</code> which is a
<code>dict</code> having the configuration of a particular instance. The <code>check</code> method is
run once per instance defined in the check configuration (discussed later).</p>

<h4 id="sending-metrics" class="linked-header">
<a class="header-link" href="#sending-metrics"><i class="fa fa-link"></i></a>Sending metrics</h4>

<p>Sending metrics in a check is easy. If you’re already familiar with the
methods available in DogStatsD, then the transition will be very simple. If
you’re not already familiar with that interface, you’ll find sending metrics is
a breeze.</p>

<p>You have the following methods available to you:</p>

<pre><code>self.gauge( ... ) # Sample a gauge metric

self.increment( ... ) # Increment a counter metric

self.decrement( ... ) # Decrement a counter metric

self.histogram( ... ) # Sample a histogram metric

self.rate( ... ) # Sample a point, with the rate calculated at the end of the check

self.count( ... ) # Sample a raw count metric

self.monotonic_count( ... ) # Sample an increasing counter metric
</code></pre>

<p>All of these methods take the following arguments:</p>

<ul>
  <li>
<code>metric</code>: The name of the metric</li>
  <li>
<code>value</code>: The value for the metric (defaults to 1 on increment, -1 on decrement)</li>
  <li>
<code>tags</code>: (optional) A list of tags to associate with this metric.</li>
  <li>
<code>hostname</code>: (optional) A hostname to associate with this metric. Defaults to the current host.</li>
  <li>
<code>device_name</code>: (optional) A device name to associate with this metric.</li>
</ul>

<p>These methods may be called from anywhere within your check logic. At the end of
your <code>check</code> function, all metrics that were submitted will be collected and
flushed out with the other Agent metrics.</p>

<h4 id="sending-events" class="linked-header">
<a class="header-link" href="#sending-events"><i class="fa fa-link"></i></a>Sending events</h4>

<p>At any time during your check, you can make a call to <code>self.event(...)</code> with one argument: the payload of the event. Your event should be structured like this:</p>

<pre><code>{
    "timestamp": int, the epoch timestamp for the event,
    "event_type": string, the event name,
    "api_key": string, the api key for your account,
    "msg_title": string, the title of the event,
    "msg_text": string, the text body of the event,
    "aggregation_key": string, a key to use for aggregating events,
    "alert_type": (optional) string, one of ('error', 'warning', 'success', 'info');
        defaults to 'info',
    "source_type_name": (optional) string, the source type name,
    "host": (optional) string, the name of the host,
    "tags": (optional) list, a list of tags to associate with this event
    "priority": (optional) string which specifies the priority of the event (Normal, Low)
}
</code></pre>

<p>At the end of your check, all events will be collected and flushed with the rest
of the Agent payload.</p>

<h4 id="sending-service-checks" class="linked-header">
<a class="header-link" href="#sending-service-checks"><i class="fa fa-link"></i></a>Sending service checks</h4>

<p>Your custom check can also report the status of a service by calling the <code>self.service_check(...)</code> method.</p>

<p>The service_check method will accept the following arguments:</p>

<ul>
  <li>
<code>check_name</code>: The name of the service check.</li>
  <li>
<code>status</code>: An integer describing the service status. You may also use the class status definitions:
    <ul>
      <li>
<code>AgentCheck.OK</code> or <code>0</code> for success</li>
      <li>
<code>AgentCheck.WARNING</code> or <code>1</code> for warning</li>
      <li>
<code>AgentCheck.CRITICAL</code> or <code>2</code> for failure</li>
      <li>
<code>AgentCheck.UNKNOWN</code> or <code>3</code> for indeterminate status</li>
    </ul>
  </li>
  <li>
<code>tags</code>: (optional) A list of key:val tags for this check.</li>
  <li>
<code>timestamp</code>: (optional) The POSIX timestamp when the check occured.</li>
  <li>
<code>hostname</code>: (optional) The name of the host submitting the check. Defaults to the host_name of the agent.</li>
  <li>
<code>check_run_id</code>: (optional) An integer ID used for logging and tracing purposes. The ID does not need to be unique. If an ID is not provided, one will automatically be generated.</li>
  <li>
<code>message</code>: (optional) Additional information or a description of why this status occured.</li>
</ul>

<h4 id="exceptions" class="linked-header">
<a class="header-link" href="#exceptions"><i class="fa fa-link"></i></a>Exceptions</h4>

<p>If a check cannot run because of improper configuration,  programming error or
because it could not collect any metrics, it should raise a meaningful exception.
This exception will be logged, as well as be shown in the Agent <a href='/guides/basic_agent_usage/ubuntu/'>info command</a> for
easy debugging. For example:</p>

<pre><code>$ sudo /etc/init.d/datadog-agent info

  Checks
  ======

    my_custom_check
    ---------------
      - instance #0 [ERROR]: ConnectionError('Connection refused.',)
      - Collected 0 metrics &amp; 0 events
</code></pre>

<h4 id="logging" class="linked-header">
<a class="header-link" href="#logging"><i class="fa fa-link"></i></a>Logging</h4>

<p>As part of the parent class, you’re given a logger at <code>self.log</code>, so you can do
things like <code>self.log.info('hello')</code>. The log handler will be <code>checks.{name}</code>
where <code>{name}</code> is the name of your check (based on the filename of the check
module).</p>

<!--
======================================================
CONFIGURATION
======================================================
-->

<h3 id="config" class="linked-header">
<a class="header-link" href="#config"><i class="fa fa-link"></i></a>Configuration</h3>

<p>Each check will have a configuration file that will be placed in the <code>conf.d</code>
directory. Configuration is written using <a href="http://www.yaml.org/">YAML</a>. The
file name should match the name of the check module (e.g.: <code>haproxy.py</code> and
<code>haproxy.yaml</code>).</p>

<p>The configuration file has the following structure:</p>

<pre class="" lang="console"><code class="">init_config:
    min_collection_interval: 20
    key1: val1
    key2: val2

instances:
    - username: jon_smith
      password: 1234

    - username: jane_smith
      password: 5678
</code></pre>
<p><code>min_collection_interval</code> can be added to the init_config section to help define how often the check should be run. If it is greater than the interval time for the agent collector, a line will be added to the log stating that collection for this script was skipped. The default is <code>0</code> which means it will be collected at the same interval as the rest of the integrations on that agent. If the value is set to 30, it does not mean that the metric will be collected every 30 seconds, but rather that it could be collected as often as every 30 seconds. The collector runs every 15-20 seconds depending on how many integrations are enabled. If the interval on this agent happens to be every 20 seconds, then the agent will collect and include the agent check. The next time it collects 20 seconds later, it will see that 20 &lt; 30 and not collect the custom agent check. The next time it will see that the time since last run was 40 which is greater than 30 and therefore the agent check will be collected.</p>

<div class="alert alert-block">Note: YAML files must use spaces instead of tabs.</div>

<h4 id="initconfig" class="linked-header">
<a class="header-link" href="#initconfig"><i class="fa fa-link"></i></a>init_config</h4>

<p>The <em>init_config</em> section allows you to have an arbitrary number of global
configuration options that will be available on every run of the check in
<code>self.init_config</code>.</p>

<h4 id="instances" class="linked-header">
<a class="header-link" href="#instances"><i class="fa fa-link"></i></a>instances</h4>

<p>The <em>instances</em> section is a list of instances that this check will be run
against. Your actual <code>check()</code> method is run once per instance. This means that
every check will support multiple instances out of the box.</p>

<!--
======================================================
DIRECTORY STRUCTURE
======================================================
-->

<h3 id="directory" class="linked-header">
<a class="header-link" href="#directory"><i class="fa fa-link"></i></a>Directory Structure</h3>

<p>Before starting your first check it is worth understanding the checks directory
structure. There are two places that you will need to add files for your check.
The first is the <code>checks.d</code> folder, which lives in your Agent root.</p>

<p>For all Linux systems, this means you will find it at:</p>

<pre><code>/etc/dd-agent/checks.d/
</code></pre>

<p>For Windows Server &gt;= 2008 you’ll find it at:</p>

<pre><code>C:\Program Files (x86)\Datadog\Agent\checks.d\

OR

C:\Program Files\Datadog\Agent\checks.d\
</code></pre>

<p>For Mac OS X and source installations, you’ll find it at:</p>

<pre><code>~/.datadog-agent/agent/checks.d/

OR

~/.pup/agent/checks.d/

OR

&lt;sandbox_folder&gt;/checks.d/
</code></pre>

<p>The other folder that you need to care about is <code>conf.d</code> which lives in the
Agent configuration root.</p>

<p>For Linux, you’ll find it at:</p>

<pre><code>/etc/dd-agent/conf.d/
</code></pre>

<p>For Windows, you’ll find it at:</p>

<pre><code>C:\ProgramData\Datadog\conf.d\

OR

C:\Documents and Settings\All Users\Application Data\Datadog\conf.d\
</code></pre>

<p>For Mac OS X and source installations, you’ll find it at:</p>

<pre><code>~/.datadog-agent/agent/conf.d/

OR

~/.pup/agent/conf.d/

OR

&lt;sandbox_folder&gt;/conf.d/
</code></pre>

<p>You can also add additional checks to a single directory, and point to it in <code>datadog.conf</code>:</p>

<pre><code>additional_checksd: /path/to/custom/checks.d/
</code></pre>

<!--
======================================================
FIRST CHECK
======================================================
-->

<h3 id="first" class="linked-header">
<a class="header-link" href="#first"><i class="fa fa-link"></i></a>Your First Check</h3>

<div class="alert alert-block">
The names of the configuration and check files must match. If your check
is called <code>mycheck.py</code> your configuration file <em>must</em> be
named <code>mycheck.yaml</code>.
</div>

<p>To start off simple, we’ll write a check that does nothing more than send a
value of 1 for the metric <code>hello.world</code>. The configuration file will be very
simple, including no real information. This will go into <code>conf.d/hello.yaml</code>:</p>

<pre class="" lang="console"><code class="">init_config:

instances:
    [{}]

</code></pre>

<p>The check itself will inherit from <code>AgentCheck</code> and send a gauge of <code>1</code> for
<code>hello.world</code> on each call. This will go in <code>checks.d/hello.py</code>:</p>

<pre class="" lang="python"><code class="language-python">from checks import AgentCheck
class HelloCheck(AgentCheck):
    def check(self, instance):
        self.gauge('hello.world', 1)

</code></pre>

<p>As you can see, the check interface is really simple and easy to get started
with. In the next section we’ll write a more useful check that will ping HTTP
services and return interesting data.</p>

<!--
======================================================
HTTP CHECK
======================================================
-->

<h3 id="http" class="linked-header">
<a class="header-link" href="#http"><i class="fa fa-link"></i></a>An HTTP Check</h3>

<p>Now we will guide you through the process of writing a basic check that will
check the status of an HTTP endpoint. On each run of the check, a GET
request will be made to the HTTP endpoint. Based on the response, one of the
following will happen:</p>

<ul>
  <li>If the response is successful (response is 200, no timeout) the response
  time will be submitted as a metric.</li>
  <li>If the response times out, an event will be submitted with the URL and
  timeout.</li>
  <li>If the response code != 200, an event will be submitted with the URL and
  the response code.</li>
</ul>

<h4 id="configuration" class="linked-header">
<a class="header-link" href="#configuration"><i class="fa fa-link"></i></a>Configuration</h4>

<p>First we will want to define how our configuration should look, so that we know
how to handle the structure of the <code>instance</code> payload that is passed into the
call to <code>check</code>.</p>

<p>Besides just defining a URL per call, it’d be nice to allow you to set a timeout
for each URL. We’d also want to be able to configure a default timeout if no
timeout value is given for a particular URL.</p>

<p>So our final configuration would look something like this:</p>

<pre class="" lang="console"><code class="">init_config:
    default_timeout: 5

instances:
    -   url: https://google.com

    -   url: http://httpbin.org/delay/10
        timeout: 8

    -   url: http://httpbin.org/status/400

</code></pre>

<h4 id="the-check" class="linked-header">
<a class="header-link" href="#the-check"><i class="fa fa-link"></i></a>The Check</h4>

<p>Now we can start defining our check method. The main part of the check will make
a request to the URL and time the response time, handling error cases as it goes.</p>

<p>In this snippet, we start a timer, make the GET request using the
<a href="http://docs.python-requests.org/en/latest/">requests library</a> and handle and
errors that might arise.</p>

<pre class="" lang="python"><code class="language-python"># Load values from the instance config
url = instance['url']
default_timeout = self.init_config.get('default_timeout', 5)
timeout = float(instance.get('timeout', default_time))

# Use a hash of the URL as an aggregation key
aggregation_key = md5(url).hexdigest()

# Check the URL
start_time = time.time()
try:
    r = requests.get(url, timeout=timeout)
    end_time = time.time()
except requests.exceptions.Timeout as e:
    # If there's a timeout
    self.timeout_event(url, timeout, aggregation_key)

if r.status_code != 200:
    self.status_code_event(url, r, aggregation_key)
</code></pre>

<p>If the request passes, we want to submit the timing to Datadog as a metric. Let’s
call it <code>http.response_time</code> and tag it with the URL.</p>

<pre class="" lang="python"><code class="language-python">timing = end_time - start_time
self.gauge('http.response_time', timing, tags=['http_check'])
</code></pre>

<p>Finally, we’ll want to define what happens in the error cases. We have already
seen that we call <code>self.timeout_event</code> in the case of a URL timeout and
we call <code>self.status_code_event</code> in the case of a bad status code. Let’s
define those methods now.</p>

<p>First, we’ll define <code>timeout_event</code>. Note that we want to aggregate all of these
events together based on the URL so we will define the aggregation_key as a hash
of the URL.</p>

<pre class="" lang="python"><code class="language-python">def timeout_event(self, url, timeout, aggregation_key):
    self.event({
        'timestamp': int(time.time()),
        'event_type': 'http_check',
        'msg_title': 'URL timeout',
        'msg_text': '%s timed out after %s seconds.' % (url, timeout),
        'aggregation_key': aggregation_key
    })
</code></pre>

<p>Next, we’ll define <code>status_code_event</code> which looks very similar to the timeout
event method.</p>

<pre class="" lang="python"><code class="language-python">def status_code_event(self, url, r, aggregation_key):
    self.event({
        'timestamp': int(time.time()),
        'event_type': 'http_check',
        'msg_title': 'Invalid response code for %s' % url,
        'msg_text': '%s returned a status of %s' % (url, r.status_code),
        'aggregation_key': aggregation_key
    })
</code></pre>

<h4 id="putting-it-all-together" class="linked-header">
<a class="header-link" href="#putting-it-all-together"><i class="fa fa-link"></i></a>Putting It All Together</h4>

<p>For the last part of this guide, we’ll show the entire check. This module would
be placed into the <code>checks.d</code> folder as <code>http.py</code>. The corresponding
configuration would be placed into the <code>conf.d</code> folder as <code>http.yaml</code>.</p>

<p>Once the check is in <code>checks.d</code>, you can test it by running it as a python
script. Restart the Agent for the changes to be enabled. <strong>Make sure to change the conf.d path in the test method</strong>. From your
Agent root, run:</p>

<pre><code>PYTHONPATH=. python checks.d/http.py
</code></pre>

<p>You’ll see what metrics and events are being generated for each instance.</p>

<p>Here’s the full source of the check:</p>

<pre class="code-block code-block-python" lang="python"><code class="language-python">import time
import requests

from checks import AgentCheck
from hashlib import md5

class HTTPCheck(AgentCheck):
    def check(self, instance):
        if 'url' not in instance:
            self.log.info("Skipping instance, no url found.")
            return

        # Load values from the instance config
        url = instance['url']
        default_timeout = self.init_config.get('default_timeout', 5)
        timeout = float(instance.get('timeout', default_timeout))

        # Use a hash of the URL as an aggregation key
        aggregation_key = md5(url).hexdigest()

        # Check the URL
        start_time = time.time()
        try:
            r = requests.get(url, timeout=timeout)
            end_time = time.time()
        except requests.exceptions.Timeout as e:
            # If there's a timeout
            self.timeout_event(url, timeout, aggregation_key)
            return

        if r.status_code != 200:
            self.status_code_event(url, r, aggregation_key)

        timing = end_time - start_time
        self.gauge('http.reponse_time', timing, tags=['http_check'])

    def timeout_event(self, url, timeout, aggregation_key):
        self.event({
            'timestamp': int(time.time()),
            'event_type': 'http_check',
            'msg_title': 'URL timeout',
            'msg_text': '%s timed out after %s seconds.' % (url, timeout),
            'aggregation_key': aggregation_key
        })

    def status_code_event(self, url, r, aggregation_key):
        self.event({
            'timestamp': int(time.time()),
            'event_type': 'http_check',
            'msg_title': 'Invalid reponse code for %s' % url,
            'msg_text': '%s returned a status of %s' % (url, r.status_code),
            'aggregation_key': aggregation_key
        })

if __name__ == '__main__':
    check, instances = HTTPCheck.from_yaml('/path/to/conf.d/http.yaml')
    for instance in instances:
        print "\nRunning the check against url: %s" % (instance['url'])
        check.check(instance)
        if check.has_events():
            print 'Events: %s' % (check.get_events())
        print 'Metrics: %s' % (check.get_metrics())</code></pre>

<!--
======================================================
Troubleshooting
======================================================
-->

<h3 id="troubleshooting" class="linked-header">
<a class="header-link" href="#troubleshooting"><i class="fa fa-link"></i></a>Troubleshooting</h3>

<p>Custom Agent checks can’t be directly called from python and instead
 need to be called by the agent. To test this, run:</p>

<pre><code>sudo -u dd-agent dd-agent check my_check
</code></pre>

<p>If your issue continues, please reach out to Support with the help page that
 lists the paths it installs.</p>

<h4 class="linked-header">
<a class="header-link" href="#"><i class="fa fa-link"></i></a>Testing Custom Checks on Windows</h4>

<p>Testing custom checks on Windows is easy. The Agent install includes a file called shell.exe
in your Program Files directory for the Datadog Agent which you can use to run python within the Agent environment.</p>

<p>Once your check (called “my_check”) is written and you have the .py and .yaml files
in their correct places, you can run the following in shell.exe:</p>

<pre><code>&gt;&gt;&gt; from checks import run_check
&gt;&gt;&gt; run_check('my_check')
</code></pre>

<p>This will output any metrics or events that the check will return.</p>

</body></html>


          
        </div>
      </div>
    </div>
    <div class="container">
  <div class="row" id="footer">
    <div class=".col-md-12">Need some help?  <a href="/help/">Get in touch.</a> &bull; Mistake in the docs? <a href="https://github.com/DataDog/documentation/issues">Let us know.</a></div>
    <div class=".col-md-12"><a href="/ja">日本語ドキュメントへのリンク。</a></div>
    <div class=".col-md-12">&copy; Datadog, Inc. All rights reserved.</div>
  </div>
</div>

    

        <script type="text/javascript">
      ;(function(p,l,o,w,i,n,g){if(!p[i]){p.GlobalSnowplowNamespace=p.GlobalSnowplowNamespace||[];
      p.GlobalSnowplowNamespace.push(i);p[i]=function(){(p[i].q=p[i].q||[]).push(arguments)
      };p[i].q=p[i].q||[];n=l.createElement(o);g=l.getElementsByTagName(o)[0];n.async=1;
      n.src=w;g.parentNode.insertBefore(n,g)}}(window,document,"script","https://don08600y3gfm.cloudfront.net/ps3b/static/js/plow232.js","snowplow"));
      window.snowplow('newTracker', 'co', 'collector.datadoghq.com', { // Initialise a tracker
      appId: 'datadog', // Application ID. Make sure you use the same value across all the tags you fire on your trial
      platform: 'web',
      cookieDomain: '.datadoghq.com',
      contexts: {
        performanceTiming: true,
        webPage: true
        }
      });
      window.snowplow('enableActivityTracking', 5, 5); // Ping every 30 seconds after 30 seconds
      window.snowplow('enableLinkClickTracking');
      window.snowplow('trackPageView');
    </script>

        <script type="text/javascript">
      (function() {
       var didInit = false;
       function initMunchkin() {
         if(didInit === false) {
           didInit = true;
           Munchkin.init('875-UVY-685');
         }
       }
       var s = document.createElement('script');
       s.type = 'text/javascript';
       s.async = true;
       s.src = '//munchkin.marketo.net/munchkin.js';
       s.onreadystatechange = function() {
         if (this.readyState == 'complete' || this.readyState == 'loaded') {
           initMunchkin();
         }
       };
       s.onload = initMunchkin;
       document.getElementsByTagName('head')[0].appendChild(s);
      })();
    </script>


    <!-- <script src="/static/jquery-1.7.2.min.js"></script> -->
<script src="/static/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/tipuesearch/tipuesearch-set.js"></script>
<script type="text/javascript" src="/tipuesearch/tipuesearch_content.js"></script>
<script type="text/javascript" src="/tipuesearch/tipuesearch.js"></script>
<script src="/static/datadog-docs.js"></script>


    <!-- No page Javascript -->
  </body>
</html>


